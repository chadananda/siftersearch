#!/bin/bash

# Pre-commit hook for SifterSearch
# Runs before each commit to:
# 1. Run linting (catches style/syntax issues)
# 2. Run unit tests (fast safety check)
# 3. Run Astro build (catches type errors and build issues)
# 4. Bump version number (patch)
# 5. Regenerate changelog from git history
# 6. Stage the updated files
#
# Skip with: git commit --no-verify
# Skip quality checks only: SKIP_CHECKS=1 git commit ...

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[pre-commit]${NC} Running pre-commit hooks..."

# Get the root of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# Check if this is an amend (don't bump version on amends)
if git rev-parse -q --verify ORIG_HEAD > /dev/null 2>&1; then
  # Check if HEAD matches ORIG_HEAD (indicates amend)
  if [ "$(git rev-parse HEAD)" = "$(git rev-parse ORIG_HEAD)" ]; then
    echo -e "${YELLOW}[pre-commit]${NC} Amend detected, skipping version bump"
    exit 0
  fi
fi

# Check if there are actual code changes (not just version files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v 'package.json\|changelog.json' || true)
if [ -z "$STAGED_FILES" ]; then
  echo -e "${YELLOW}[pre-commit]${NC} No code changes staged, skipping version bump"
  exit 0
fi

# 0. Run quality checks (unless SKIP_CHECKS=1)
if [ "$SKIP_CHECKS" != "1" ]; then
  # Run linting
  echo -e "${GREEN}[pre-commit]${NC} Running linter..."
  if npm run lint 2>&1; then
    echo -e "${GREEN}[pre-commit]${NC} Linting passed!"
  else
    echo -e "${RED}[pre-commit]${NC} Linting failed! Commit aborted."
    echo -e "${YELLOW}[pre-commit]${NC} Fix lint errors or use SKIP_CHECKS=1 to bypass"
    exit 1
  fi

  # Run unit tests
  echo -e "${GREEN}[pre-commit]${NC} Running unit tests..."
  if npm run test 2>&1; then
    echo -e "${GREEN}[pre-commit]${NC} Tests passed!"
  else
    echo -e "${RED}[pre-commit]${NC} Tests failed! Commit aborted."
    echo -e "${YELLOW}[pre-commit]${NC} Fix the tests or use SKIP_CHECKS=1 to bypass"
    exit 1
  fi

  # Run Astro build (catches type errors and build issues)
  echo -e "${GREEN}[pre-commit]${NC} Running Astro build check..."
  if npm run build 2>&1; then
    echo -e "${GREEN}[pre-commit]${NC} Build passed!"
  else
    echo -e "${RED}[pre-commit]${NC} Build failed! Commit aborted."
    echo -e "${YELLOW}[pre-commit]${NC} Fix build errors or use SKIP_CHECKS=1 to bypass"
    exit 1
  fi

  # Verify server imports (catches missing dependencies)
  echo -e "${GREEN}[pre-commit]${NC} Checking server imports..."
  if node scripts/check-server-imports.js 2>&1; then
    echo -e "${GREEN}[pre-commit]${NC} Server imports OK!"
  else
    echo -e "${RED}[pre-commit]${NC} Server import check failed! Missing dependency?"
    echo -e "${YELLOW}[pre-commit]${NC} Run 'npm install' and check for missing packages"
    exit 1
  fi
else
  echo -e "${YELLOW}[pre-commit]${NC} SKIP_CHECKS=1, skipping quality checks"
fi

# 1. Bump version
echo -e "${GREEN}[pre-commit]${NC} Bumping version..."
NEW_VERSION=$(node scripts/bump-version.js patch 2>&1 | tail -1)

# 2. Regenerate changelog
echo -e "${GREEN}[pre-commit]${NC} Regenerating changelog..."
node scripts/generate-changelog.js > /dev/null 2>&1

# 3. Stage the updated files
echo -e "${GREEN}[pre-commit]${NC} Staging updated files..."
git add package.json src/lib/changelog.json

echo -e "${GREEN}[pre-commit]${NC} Version bumped to ${NEW_VERSION}"
echo -e "${GREEN}[pre-commit]${NC} Pre-commit hooks completed successfully"
