#!/bin/bash

# Pre-commit hook for SifterSearch
# Runs before each commit to:
# 1. Bump version number (patch)
# 2. Regenerate changelog from git history
# 3. Stage the updated files
#
# Skip with: git commit --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[pre-commit]${NC} Running pre-commit hooks..."

# Get the root of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# Check if this is an amend (don't bump version on amends)
if git rev-parse -q --verify ORIG_HEAD > /dev/null 2>&1; then
  # Check if HEAD matches ORIG_HEAD (indicates amend)
  if [ "$(git rev-parse HEAD)" = "$(git rev-parse ORIG_HEAD)" ]; then
    echo -e "${YELLOW}[pre-commit]${NC} Amend detected, skipping version bump"
    exit 0
  fi
fi

# Check if there are actual code changes (not just version files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v 'package.json\|changelog.json' || true)
if [ -z "$STAGED_FILES" ]; then
  echo -e "${YELLOW}[pre-commit]${NC} No code changes staged, skipping version bump"
  exit 0
fi

# 1. Bump version
echo -e "${GREEN}[pre-commit]${NC} Bumping version..."
NEW_VERSION=$(node scripts/bump-version.js patch 2>&1 | tail -1)

# 2. Regenerate changelog
echo -e "${GREEN}[pre-commit]${NC} Regenerating changelog..."
node scripts/generate-changelog.js > /dev/null 2>&1

# 3. Stage the updated files
echo -e "${GREEN}[pre-commit]${NC} Staging updated files..."
git add package.json src/lib/changelog.json

echo -e "${GREEN}[pre-commit]${NC} Version bumped to ${NEW_VERSION}"
echo -e "${GREEN}[pre-commit]${NC} Pre-commit hooks completed successfully"
