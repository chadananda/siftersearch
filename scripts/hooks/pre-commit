#!/bin/bash

# Pre-commit hook for SifterSearch
#
# Complete deployment pipeline - all steps must pass or commit is aborted:
# 1. Run linting (catches style/syntax issues)
# 2. Run unit tests (fast safety check)
# 3. Verify server imports (catches missing dependencies)
# 4. Build client for production
# 5. Deploy client to Cloudflare Pages
# 6. Push to GitHub (triggers server auto-update)
# 7. Bump version and update changelog
# 8. Stage version files for commit
#
# Skip with: git commit --no-verify
# Skip quality checks only: SKIP_CHECKS=1 git commit ...

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[pre-commit]${NC} Running pre-commit hooks..."

# Get the root of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# Check if this is an amend (don't bump version on amends)
if git rev-parse -q --verify ORIG_HEAD > /dev/null 2>&1; then
  if [ "$(git rev-parse HEAD)" = "$(git rev-parse ORIG_HEAD)" ]; then
    echo -e "${YELLOW}[pre-commit]${NC} Amend detected, skipping deployment"
    exit 0
  fi
fi

# Check if there are actual code changes (not just version files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -v 'package.json\|changelog.json' || true)
if [ -z "$STAGED_FILES" ]; then
  echo -e "${YELLOW}[pre-commit]${NC} No code changes staged, skipping deployment"
  exit 0
fi

# Load deploy secret from .env-secrets
if [ -f .env-secrets ]; then
  DEPLOY_SECRET=$(grep "^DEPLOY_SECRET=" .env-secrets | cut -d'=' -f2)
fi

# ============================================
# PHASE 1: Quality Checks (fail fast)
# ============================================

if [ "$SKIP_CHECKS" != "1" ]; then
  # Run linting
  echo -e "${GREEN}[pre-commit]${NC} Running linter..."
  if ! npm run lint 2>&1; then
    echo -e "${RED}[pre-commit]${NC} Linting failed! Commit aborted."
    exit 1
  fi
  echo -e "${GREEN}[pre-commit]${NC} ✓ Linting passed"

  # Run unit tests
  echo -e "${GREEN}[pre-commit]${NC} Running unit tests..."
  if ! npm run test 2>&1; then
    echo -e "${RED}[pre-commit]${NC} Tests failed! Commit aborted."
    exit 1
  fi
  echo -e "${GREEN}[pre-commit]${NC} ✓ Tests passed"

  # Verify server imports (catches missing dependencies)
  echo -e "${GREEN}[pre-commit]${NC} Checking server imports..."
  if ! node scripts/check-server-imports.js 2>&1; then
    echo -e "${RED}[pre-commit]${NC} Server import check failed! Commit aborted."
    exit 1
  fi
  echo -e "${GREEN}[pre-commit]${NC} ✓ Server imports OK"
else
  echo -e "${YELLOW}[pre-commit]${NC} SKIP_CHECKS=1, skipping quality checks"
fi

# ============================================
# PHASE 2: Bump Version (BEFORE build so it's baked into client)
# ============================================

echo -e "${BLUE}[pre-commit]${NC} Bumping version..."
NEW_VERSION=$(node scripts/bump-version.js patch 2>&1 | tail -1)
echo -e "${GREEN}[pre-commit]${NC} ✓ Version: ${NEW_VERSION}"

# ============================================
# PHASE 3: Build Client for Production (with new version)
# ============================================

echo -e "${BLUE}[pre-commit]${NC} Building client for production..."
if ! PUBLIC_API_URL=https://api.siftersearch.com PUBLIC_DEPLOY_SECRET="$DEPLOY_SECRET" npm run build 2>&1; then
  echo -e "${RED}[pre-commit]${NC} Build failed! Commit aborted."
  exit 1
fi
echo -e "${GREEN}[pre-commit]${NC} ✓ Build passed"

# Regenerate changelog with new version
node scripts/generate-changelog.js > /dev/null 2>&1

# Stage version files
git add package.json src/lib/changelog.json

# ============================================
# PHASE 4: Deploy Client to Cloudflare Pages (with retries)
# ============================================

deploy_to_cloudflare() {
  local max_retries=3
  local retry_delay=5

  for ((i=1; i<=max_retries; i++)); do
    echo -e "${BLUE}[pre-commit]${NC} Deploying to Cloudflare Pages (attempt $i/$max_retries)..."
    if npx wrangler pages deploy ./dist --project-name siftersearch --branch main --commit-dirty=true --commit-message="v${NEW_VERSION}" 2>&1; then
      return 0
    fi

    if [ $i -lt $max_retries ]; then
      echo -e "${YELLOW}[pre-commit]${NC} Deploy failed, retrying in ${retry_delay}s..."
      sleep $retry_delay
      retry_delay=$((retry_delay * 2))
    fi
  done
  return 1
}

if ! deploy_to_cloudflare; then
  echo -e "${RED}[pre-commit]${NC} Client deployment failed after 3 attempts! Commit aborted."
  echo -e "${YELLOW}[pre-commit]${NC} Version was bumped but not deployed. Run: git restore package.json src/lib/changelog.json"
  exit 1
fi
echo -e "${GREEN}[pre-commit]${NC} ✓ Client deployed to Cloudflare Pages (production)"

# ============================================
# PHASE 5: Push to GitHub (triggers server update)
# ============================================

# We need to complete the commit first, then push
# This is handled by creating a post-commit hook that just pushes

echo -e "${GREEN}[pre-commit]${NC} ✓ All checks passed, deployment ready"
echo -e "${BLUE}[pre-commit]${NC} Client: https://siftersearch.com (v${NEW_VERSION})"
echo -e "${BLUE}[pre-commit]${NC} Server will auto-update when commit is pushed"
