---
/**
 * Library Catch-All Route
 *
 * Handles semantic URLs at three levels:
 * - /library/{religion} - Religion overview page
 * - /library/{religion}/{collection} - Collection page with document list
 * - /library/{religion}/{collection}/{slug} - Document presentation page
 */
import Layout from '../../layouts/Layout.astro';
import NavBar from '../../components/common/NavBar.svelte';
import ReligionPage from '../../components/library/ReligionPage.svelte';
import CollectionPage from '../../components/library/CollectionPage.svelte';
import DocumentPresentation from '../../components/library/DocumentPresentation.svelte';

// Disable prerendering - these pages fetch data client-side
export const prerender = false;

const { path } = Astro.params;

// Parse the path segments
const segments = path?.split('/').filter(Boolean) || [];
const [religion, collection, slug] = segments;

// Get view mode from query parameter (for shareable links)
const viewMode = Astro.url.searchParams.get('view') || 'default';

// For document pages, check for redirects server-side
// This ensures proper SEO with HTTP 301 redirects
if (segments.length === 3) {
  const API_BASE = import.meta.env.PUBLIC_API_URL || '';
  try {
    const res = await fetch(
      `${API_BASE}/api/library/by-path/${religion}/${collection}/${slug}?limit=1`,
      { redirect: 'manual' }  // Don't follow redirects automatically
    );

    // If API returns a redirect, forward it to the browser
    if (res.status === 301 || res.status === 302 || res.status === 308) {
      const location = res.headers.get('location');
      if (location) {
        // Convert API path to frontend path
        // API returns: /library/religion/collection/slug
        // We need: /library/religion/collection/slug (same, but on frontend domain)
        const frontendPath = location.replace(/^\/api\/library\/by-path/, '/library');
        return Astro.redirect(frontendPath, 301);
      }
    }
  } catch (e) {
    // If redirect check fails, continue with normal rendering
    // The client-side component will handle errors
    console.error('Redirect check failed:', e);
  }
}

// Determine page type based on segment count
const pageType = segments.length === 1 ? 'religion'
              : segments.length === 2 ? 'collection'
              : segments.length === 3 ? 'document'
              : 'invalid';

// Format religion/collection names for display (capitalize, handle diacritics display)
function formatName(slug) {
  if (!slug) return '';
  // Convert slug back to display name (basic - API will provide proper names)
  return slug
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// Generate page title and description based on type
function getPageMeta() {
  switch (pageType) {
    case 'religion':
      const religionName = formatName(religion);
      return {
        title: `${religionName} - SifterSearch Library`,
        description: `Explore ${religionName} sacred texts, scriptures, and scholarly works in the SifterSearch interfaith library.`,
        keywords: `${religionName}, sacred texts, scriptures, religious texts, interfaith library`
      };
    case 'collection':
      const collName = formatName(collection);
      const relName = formatName(religion);
      return {
        title: `${collName} - ${relName} - SifterSearch Library`,
        description: `Browse the ${collName} collection from the ${relName} tradition in the SifterSearch interfaith library.`,
        keywords: `${collName}, ${relName}, sacred texts, religious collection, interfaith library`
      };
    case 'document':
      const viewSuffix = viewMode === 'sbs' ? ' (Side-by-Side)'
                      : viewMode === 'study' ? ' (Study Mode)'
                      : '';
      return {
        title: `Document${viewSuffix} - SifterSearch Library`,
        description: `Read this document from the SifterSearch interfaith library${viewSuffix.toLowerCase()}.`,
        keywords: `sacred text, religious document, interfaith library`
      };
    default:
      return {
        title: `Not Found - SifterSearch`,
        description: `Page not found`,
        keywords: ``
      };
  }
}

const meta = getPageMeta();

// Build canonical URL
const canonicalUrl = `https://siftersearch.com/library/${path}`;
---

<Layout
  title={meta.title}
  description={meta.description}
>
  <!-- Additional SEO meta tags -->
  <Fragment slot="head">
    <meta name="keywords" content={meta.keywords} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:title" content={meta.title} />
    <meta property="og:description" content={meta.description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content={pageType === 'document' ? 'article' : 'website'} />
    <meta property="og:site_name" content="SifterSearch" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={meta.title} />
    <meta name="twitter:description" content={meta.description} />

    <!-- Structured Data for breadcrumbs -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Library",
          "item": "https://siftersearch.com/library"
        },
        ...(religion ? [{
          "@type": "ListItem",
          "position": 2,
          "name": formatName(religion),
          "item": `https://siftersearch.com/library/${religion}`
        }] : []),
        ...(collection ? [{
          "@type": "ListItem",
          "position": 3,
          "name": formatName(collection),
          "item": `https://siftersearch.com/library/${religion}/${collection}`
        }] : []),
        ...(slug ? [{
          "@type": "ListItem",
          "position": 4,
          "name": formatName(slug),
          "item": canonicalUrl
        }] : [])
      ]
    })} />
  </Fragment>

  <NavBar client:load currentPage="library" />

  {pageType === 'religion' && (
    <ReligionPage
      client:load
      religionSlug={religion}
    />
  )}

  {pageType === 'collection' && (
    <CollectionPage
      client:load
      religionSlug={religion}
      collectionSlug={collection}
    />
  )}

  {pageType === 'document' && (
    <DocumentPresentation
      client:load
      pathReligion={religion}
      pathCollection={collection}
      pathSlug={slug}
      initialViewMode={viewMode}
    />
  )}

  {pageType === 'invalid' && (
    <div class="error-container">
      <h1>Page Not Found</h1>
      <p>The page you're looking for doesn't exist or the URL is invalid.</p>
      <a href="/library">Back to Library</a>
    </div>
  )}
</Layout>

<style>
  .error-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1rem;
    text-align: center;
    padding: 2rem;
  }

  .error-container h1 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin: 0;
  }

  .error-container p {
    color: var(--text-secondary);
    margin: 0;
  }

  .error-container a {
    color: var(--accent-primary);
    text-decoration: none;
    margin-top: 1rem;
  }

  .error-container a:hover {
    text-decoration: underline;
  }
</style>
