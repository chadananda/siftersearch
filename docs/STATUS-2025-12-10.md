# SifterSearch Status - December 10, 2025

## Current Issue
Chat functionality shows "Network error. Please check your connection." on production site (siftersearch.com), while stats load correctly.

## KEY OBSERVATION
- **Stats endpoint works** - uses `request()` helper without `credentials: 'include'`
- **Chat streaming fails** - uses direct `fetch()` with `credentials: 'include'`

The streaming fetch in `src/lib/api.js:222-234` has `credentials: 'include'`:
```javascript
const response = await fetch(url, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json', ... },
  body: JSON.stringify({ query, limit: 10, mode: 'hybrid' }),
  credentials: 'include'  // <-- THIS is the difference
});
```

When `credentials: 'include'` is used, browsers require:
1. `Access-Control-Allow-Origin` to be the EXACT origin (not `*`)
2. `Access-Control-Allow-Credentials: true`

The server returns `Access-Control-Allow-Origin: *` which browsers reject for credentialed requests.

## POTENTIAL FIXES

### Option 1: Remove credentials from streaming request (QUICK)
In `src/lib/api.js:233`, remove `credentials: 'include'` since the stream endpoint doesn't need auth.

### Option 2: Fix server CORS (PROPER)
In `api/server.js`, change the CORS callback to echo the specific origin:
```javascript
if (allowedOrigins.includes(origin)) {
  return callback(null, origin);  // Echo specific origin, not true
}
```

## What Was Done

### 1. Cloudflare Tunnel Restarted
- Tunnel was down (error 1033)
- Restarted: `cloudflared tunnel --config /Users/chad/.cloudflared/config-siftersearch.yml run siftersearch-api`
- Now healthy: `curl https://api.siftersearch.com/health` returns OK

### 2. Environment Variables Fixed
- Added `PUBLIC_API_URL=https://api.siftersearch.com` to `.env-public`
- Note: `astro.config.mjs` already had this as default, so this was redundant

### 3. Client Rebuilt and Redeployed
- Version bumped: 0.0.35 → 0.0.36 in `package.json`
- Clean rebuild: `rm -rf dist && npm run build`
- Deployed to Cloudflare Pages: `npm run deploy`
- Deployment URL: https://3bef85c6.siftersearch.pages.dev

### 4. Verifications Performed
- API health check: ✅ Working via tunnel
- CORS headers: ✅ Correctly configured for siftersearch.com
- Built JS: ✅ Contains correct API URL (https://api.siftersearch.com)
- Streaming endpoint: ✅ Works via curl

## Current State
- **API**: Running on localhost:3000, exposed via Cloudflare tunnel at api.siftersearch.com
- **Frontend**: Deployed to Cloudflare Pages (version 0.0.36)
- **Tunnel**: Running and healthy

## To Test
1. Go to https://siftersearch.com
2. Hard refresh (Cmd+Shift+R / Ctrl+Shift+R)
3. Try sending a chat message

## If Still Failing
Check browser DevTools → Network tab:
1. Look for request to `api.siftersearch.com/api/search/analyze/stream`
2. Check actual error (status code, response body)
3. Check Console tab for JS errors

### Possible Issues to Investigate
1. **Service Worker caching old assets** - May need to unregister SW in DevTools → Application → Service Workers
2. **Browser-specific fetch/streaming issue** - Try different browser
3. **SSE parsing issue in client** - Check `src/lib/api.js` lines 219-296
4. **Error handling catching wrong error type** - Check `src/components/ChatInterface.svelte` lines 151-168

## Key Files
- `src/lib/api.js` - API client, streaming implementation
- `src/components/ChatInterface.svelte` - Chat UI, error handling
- `api/server.js` - CORS config
- `api/routes/search.js` - Streaming endpoint
- `.env-public` - Environment variables
- `astro.config.mjs` - Vite define for PUBLIC_API_URL

## Commands to Restart Services
```bash
# API server
node api/index.js

# Cloudflare tunnel
cloudflared tunnel --config /Users/chad/.cloudflared/config-siftersearch.yml run siftersearch-api

# Rebuild and deploy
npm run build && npm run deploy
```

## Background Processes to Clean Up
Many stale background bash processes accumulated from debugging. Run:
```bash
pkill -f "cloudflared.*siftersearch"
pkill -f "node api/index.js"
```
Then restart fresh.
